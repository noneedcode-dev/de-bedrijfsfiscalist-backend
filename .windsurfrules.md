# De Bedrijfsfiscalist Backend — Windsurf Rules

## Goal
Maintain a secure, GDPR-minded, multi-tenant API for Bubble frontend.
Never break tenant isolation, standard error responses, audit logging, or idempotency.

---

## Non-negotiables
1) DO NOT edit `dist/` by hand. Always change `src/` and run `npm run build` if needed.
2) Keep CI green: `npm run lint` + `npm test` must pass before finishing a task.
3) All `/api/*` routes require:
   - rate limiting
   - API key middleware
   - standardized error responses via global `errorHandler`
4) All `/api/clients/:clientId/*` routes MUST include:
   - `authenticateJWT`
   - `validateClientAccess` (tenant enforcement)

---

## Security & tenancy
- Default to RLS-friendly behavior.
- Use `createSupabaseAdminClient()` ONLY when required (admin listings, jobs, special joins).
- Never accept `client_id` from body/query for authorization. Only trust path param `:clientId` + `req.user`.
- Never log secrets/tokens in audit logs, request logs, or error details.

---

## Error handling contract
- Throw `AppError` (or `AppError.fromCode`) for expected errors.
- Validation errors must return HTTP 422.
- Use the standard response shape:
  `{ code, message, details?, request_id, timestamp }`
- Do not introduce new ad-hoc error formats.

---

## Validation rules
- Every endpoint must validate:
  - `clientId` UUID in params (if present)
  - request body/query types + bounds
- Prefer existing patterns:
  - `express-validator` + `handleValidationErrors`
  - Zod only when it improves clarity (complex payloads)

---

## Response conventions
- List endpoints return:
  `{ data: [...], meta: { total, limit, offset, timestamp } }`
- Single-object endpoints return:
  `{ data: {...}, meta?: {...} }`
- Keep responses deterministic: stable field names, stable ordering for export-oriented payloads.

---

## Audit logging
- Log minimum critical actions:
  - documents upload/download/list
  - tax calendar status changes + summary/upcoming views
  - risk create/update/delete + imports + exports
  - time entry create/update + export
  - messages export operations
- Use `auditLogService.logAsync(...)`.
- Metadata must be sanitized (no tokens, secrets, passwords).

---

## Documents (highest priority)
- Must guarantee: 1 file upload => exactly 1 DB record.
- Upload must be idempotent (Idempotency-Key or deterministic hash).
- Always store:
  - original filename (cleaned for display)
  - created_at, created_by, size, mime_type
  - storage_key unique constraint
- Download:
  - enforce tenant authorization
  - prefer signed URL / controlled streaming
- Listing must show correct upload date and user-friendly filename.

---

## Tax domain rules
### Tax Return Calendar
- `summary`: count Done vs Not Done (and optionally breakdown)
- `upcoming`: deadlines within 3 months AND status != Done
- Never change these semantics without updating docs/tests.

### Tax Risk Controls
- Scoring must be deterministic: chance × impact
- Monitoring field is first-class (stored + returned)
- Support Word-friendly export (aesthetic table output) via dedicated endpoint if needed.

### Tax Function
- Support 5-column structure (RACI-like) and allow per-line explanation notes.

---

## Time tracking & tokens
- Support:
  - manual time entry (date, duration, task, advisor)
  - free-hours per subscription (4h / 9h monthly)
  - billing starts only after free balance consumed
- Token reset / month rollover must be explicit and testable.

---

## Chat & exports
- Attachments must be supported end-to-end (upload + permission + download).
- Message export:
  - filter by date range (from/to)
  - optional client filter
  - export action must be logged in audit_logs

---

## How to add a new module
Create under `src/modules/<moduleName>/`:
- `<module>.routes.ts` (routing + validation + swagger)
- `<module>.service.ts` (business logic)
- `<module>.schemas.ts` (optional; validation)
Add route mount in `src/app.ts`.
Add tests in `src/**/__tests__` using vitest + supertest.

---

## Tests
- Prefer integration-style tests with supertest.
- For auth in tests:
  - use NODE_ENV=test token path and required claims (sub, role, client_id for client role)
- Always test:
  - tenant isolation (403 cross-client)
  - idempotency (documents upload double request => 1 record)
  - error shape contract
