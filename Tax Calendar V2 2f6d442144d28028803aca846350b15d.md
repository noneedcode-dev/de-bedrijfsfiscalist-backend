# Tax Calendar V2

## Amaç

Client Dashboard’daki **Tax Calendar** sekmesini “Excel/Sheet benzeri admin input → portalda okunur output” modeline geçirmek.

- Dinamik kolonlar (kolon ekleme / kolon sıralama / client’a göre tablo çeşitliliği)
- Multi-tenant izolasyon (client verisi sadece kendi clientId’si altında)
- Dashboard özetleri (summary/upcoming) aynı datasetten türesin
- Overwrite davranışı kontrollü olsun (replace import = overwrite)

---

## Kapsam

- Yeni DB modeli: `tax_calendar_tables` + `tax_calendar_rows`
- UI için yeni endpoint: `GET /api/clients/:clientId/tax/calendar/tables`
- Admin import endpoint: `POST /api/clients/:clientId/tax/calendar/import?mode=replace`
- Mevcut endpointler bozulmadan çalışmaya devam etsin:
    - `GET /api/clients/:clientId/tax/calendar`
    - `GET /api/clients/:clientId/tax/calendar/summary`
    - `GET /api/clients/:clientId/tax/calendar/upcoming`

---

## Karar

- Dinamik kolonlar: `tables.columns_json` (jsonb)
- Satır ekstra alanları: `rows.fields_json` (jsonb)
- Sorgu kolaylığı ve geriye uyumluluk için **VIEW**: `tax_calendar_entries_v2`
- Replace import: tek transaction **RPC** ile (partial write yok)

---

## 0) Ön Kontroller (Repo)

- Backend route’ları `/api/clients/:clientId/tax/*` altında.
- Supabase client kullanım pattern’i: (postgrest) `.from(...).select(...)` ve/veya `rpc(...)`
- Audit log pattern’i mevcut (action/entity/metadata)

---

## 1) DB / Supabase Migration

### 1.1 Yeni migration dosyası oluştur

Path:

- `supabase/migrations/20260128_tax_calendar_v2.sql`

İçerik (özet):

1. `tax_calendar_tables`
- `id uuid pk default gen_random_uuid()`
- `client_id uuid not null`
- `jurisdiction text not null` (örn: "NL")
- `tax_type text not null` (örn: "Dutch Corporate Income Tax")
- `title text not null` (örn: "Corporate Income Tax")
- `table_order int not null default 0`
- `columns_json jsonb not null default '[]'::jsonb`
- `created_at timestamptz default now()`
- `updated_at timestamptz default now()`
1. `tax_calendar_rows`
- `id uuid pk default gen_random_uuid()`
- `client_id uuid not null`
- `table_id uuid not null references tax_calendar_tables(id) on delete cascade`
- `entity_name text not null`
- `period_label text not null` (örn: "2024", "2025-01", "2024-Q4")
- `deadline date not null`
- `status text not null default 'open'` (open|in_progress|done|overdue)
- `row_order int not null default 0`
- `fields_json jsonb not null default '{}'::jsonb`
- `created_at timestamptz default now()`
- `updated_at timestamptz default now()`
1. Indexler
- `tax_calendar_tables(client_id, jurisdiction, tax_type)`
- `tax_calendar_rows(client_id, table_id, deadline)`
- `tax_calendar_rows(client_id, status)`
- (opsiyonel) unique: `tax_calendar_rows(client_id, table_id, entity_name, period_label, deadline)` (merge yoksa şart değil)
1. VIEW: `tax_calendar_entries_v2`
- tables + rows join
- Sütunlar:
    - row_id ([rows.id](http://rows.id/)), client_id, table_id
    - jurisdiction, tax_type, title, table_order, columns_json
    - entity_name, period_label, deadline, status, row_order, fields_json
1. RLS
- `tax_calendar_tables` ve `tax_calendar_rows` için RLS enable.
- Policy yaklaşımı:
    - Client JWT context’te sadece `SELECT` (kendi client_id’si)
    - Admin (service role veya backend admin JWT claim) full access

> Not: RLS/claim mekanizmanız projede nasıl ise ona göre uyarlayın. Eğer backend tüm client endpointlerini service role ile çalıştırıyorsa, RLS yerine backend-level erişim daha kritik; yine de RLS’yi “defense-in-depth” olarak kurun.
> 
1. RPC: `tax_calendar_replace_import(p_client_id uuid, p_payload jsonb)`
- Transaction içinde:
    - 
        1. `delete from tax_calendar_rows where client_id = p_client_id`
    - 
        1. `delete from tax_calendar_tables where client_id = p_client_id`
    - 
        1. payload.tables insert → her bir table için rows insert
- `security definer` + search_path sabitle
- Payload şeması:

```json
{
  "tables": [
    {
      "jurisdiction": "NL",
      "tax_type": "Dutch Corporate Income Tax",
      "title": "Corporate Income Tax",
      "table_order": 1,
      "columns": [
        {"key":"entity_name","label":"Entity","type":"text","order":1},
        {"key":"period_label","label":"Tax Period","type":"text","order":2},
        {"key":"deadline","label":"Filing deadline","type":"date","order":3},
        {"key":"status","label":"Status","type":"select","order":4},
        {"key":"extension_regime","label":"Extension regime","type":"text","order":5},
        {"key":"preliminary_assessment","label":"Preliminary assessment","type":"text","order":6},
        {"key":"tax_interest","label":"Tax interest","type":"number","order":7},
        {"key":"remarks","label":"Remarks","type":"multiline","order":8},
        {"key":"important_positions","label":"Important positions","type":"multiline","order":9}
      ],
      "rows": [
        {
          "entity_name":"Holding B.V.",
          "period_label":"2024",
          "deadline":"2025-06-01",
          "status":"open",
          "row_order": 1,
          "fields":{
            "extension_regime":"Becon-regeling",
            "preliminary_assessment":"Yes, paid timely",
            "tax_interest":0,
            "remarks":"Line1\\nLine2",
            "important_positions":"Position 1\\nPosition 2"
          }
        }
      ]
    }
  ]
}

```